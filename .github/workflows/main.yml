name: Build Android Kernel Module

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc-aarch64-linux-gnu \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          wget
        
        # 下载 Android NDK (如果需要)
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip android-ndk-r25c-linux.zip
        export ANDROID_NDK=$(pwd)/android-ndk-r25c
        export PATH=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
    
    - name: Configure environment
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-android-" >> $GITHUB_ENV
        echo "KERNEL_SRC=/tmp/kernel" >> $GITHUB_ENV
        
        # 创建目录结构
        mkdir -p khack
        cp *.h *.c khack/
        cp Makefile Kconfig khack/
    
    - name: Build module
      run: |
        cd khack
        make clean
        make -j$(nproc)
        
        # 检查输出文件
        if [ -f khack.ko ]; then
          echo "Build successful!"
          ls -la khack.ko
          file khack.ko
        else
          echo "Build failed!"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: khack-module
        path: khack/khack.ko
